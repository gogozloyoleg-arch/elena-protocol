# Протокол «Елена» — текущее состояние проекта

Краткое описание всего, что реализовано на данном этапе разработки.

---

## Общая идея

**Елена** — пост-квантовая децентрализованная платёжная сеть с механизмами:

- **«Атмосферный консенсус»** — уверенность в транзакциях растёт за счёт ссылок в графе и репутации узлов.
- **«Эхо-локация»** — обнаружение двойной траты по коллизиям якоря (anchor) без глобального лидера.
- **Alert** — при коллизии по одному якорю от двух разных получателей узел рассылает Alert, репутация атакующего падает.

В проекте два контура: **симулятор на Python** (исследования и эксперименты) и **прототип на Rust** (реализуемая сеть с реальным P2P).

---

## 1. Симулятор (elena-sim, Python)

### Назначение

- Проверка протокола на больших графах (десятки–сотни узлов, сотни шагов).
- Сценарии: честная сеть, классическая двойная трата, квантовая двойная трата, сибил с квантовым усилением.
- A/B тесты (chaff, rewiring), метрики, визуализация.

### Структура

| Каталог / файл | Содержимое |
|----------------|------------|
| **core/** | Ядро протокола |
| `node.py` | Честный узел: баланс, репутация, пересылка транзакций, награды за пересылку/алерт, затухание репутации по шагам |
| `quantum_node.py` | Злой узел: двойная трата, «умная» атака (разделение пиров по репутации, разная очередность отправки) |
| `transaction.py` | Транзакция: якорь, подпись, хеш контента |
| `graph.py` | Граф: узлы, рёбра, распространение транзакций с учётом first_hop_peers (для сценариев квантовой атаки) |
| `crypto.py` | Якорь, подпись/верификация (заглушка), хеш контента транзакции |
| **config/** | |
| `settings.py` | Параметры репутации (награда за пересылку/алерт, decay, min/max), метрики, по умолчанию `chaff_probability: 0` |
| **simulation/** | |
| `runner.py` | Пошаговый цикл: генерация транзакций, распространение, decay репутации, переподключение (rewiring), сбор метрик (диаметр, пути) |
| `scenarios.py` | Сценарии 1–4: один/несколько злых узлов, warmup (например 50 шагов), вывод: шаг обнаружения, узлы с алертом, репутация злого до/после |
| `metrics.py` | Метрики: средняя уверенность, покрытие алертом, пиковая нагрузка, успешная атака, ложные срабатывания и др. |
| **visualization/** | |
| `dashboard.py` | FastAPI: раздача HTML, API графа (с флагом is_evil по узлам), WebSocket при необходимости |
| `dashboard_page.html` | Интерактивный граф (vis-network), анимация распространения tx1/tx2 (волны BFS), панель метрик |
| `plots.py` | Построение графиков по результатам |
| **main.py** | Точка входа: `--scenario`, `--nodes`, `--steps`, `--evil`, `--quantum`, `--sophisticated`, `--no-chaff`, `--no-rewiring`, `--chaff-prob`, `--rewiring-*`, `--batch`, `--viz`; в batch выводит `AB_RESULT=<json>` |
| **run_batch.py** | 8 конфигураций A/B (baseline без chaff и др.), масштаб (small/default/large), `--scale`, `--max-tests`, запись CSV и логов в `results/ab_tests_<date>/` |
| **plot_results.py** | Чтение CSV, 6 графиков сравнения, сохранение в `comparison_plots.png` |
| **run_ab_tests.sh** | Запуск батча и построение графиков (NODES=200, STEPS=500) |
| **RESULTS.md** | Итоги экспериментов: эхо-локация, надёжность, рекомендация no_chaff, масштаб, несколько злых узлов |

### Реализованные возможности

- Репутация: награда за пересылку транзакции и за алерт, затухание по шагам, min/max.
- Несколько злых узлов (`--evil N`), подсчёт уникальных узлов с алертом.
- «Умная» квантовая атака: разная очередность отправки конфликтующих транзакций разным пирам.
- Визуализация: граф с раскраской по репутации, анимация распространения двух транзакций.
- A/B тесты и документация по результатам в README и RESULTS.md.

---

## 2. Прототип сети (elena-core, Rust)

### Назначение

- Реализация узла «Елены» с пост-квантовой криптографией и реальным P2P.
- Основа для дальнейшего запуска сети и тестов в реальной среде.

### Структура

| Модуль / файл | Содержимое |
|---------------|------------|
| **crypto/** | |
| `mod.rs` | **Dilithium3** (NIST): генерация ключей, подпись/верификация (SignedMessage), `KeyPair`, `PublicKeyBytes`. **SHA3-512** для хешей. `hash_512`, `generate_nonce`, `current_timestamp_ms`, `CryptoError`. |
| **graph/** | |
| `mod.rs` | Реэкспорт типов из `transaction`. |
| `transaction.rs` | **Transaction**: id (SHA3-512 от контента), from/to (from = публичный ключ отправителя), amount, nonce, anchor, parents, timestamp, подпись, `content_to_sign`, `compute_id`, `new(keypair)`, `verify_signature`. **Alert**: id, conflicting_tx1/2, anchor, discovered_by, timestamp, propagation_count. **LocalGraph**: хранилище транзакций, индексы по отправителю и якорю, проверка коллизий при добавлении (один отправитель, один якорь, разные получатели → ошибка), `find_collisions`, `get_confidence`, `recent_tx_ids_for_sender`. Сериализация Serde для полей `[u8; 64]` (кастомные serialize/deserialize). |
| **consensus/** | |
| `echo.rs` | **EchoConfig**, **CollisionDetector**: по якорю множество TxId, `check_transaction`, `time_since_first_seen`. **EchoLocator**: граф ссылок между транзакциями, `add_reference`, `update_confidence`, `is_final`, `atmospheric_pressure`. |
| **network/** | |
| `p2p.rs` | Реальный **libp2p**: SwarmBuilder (TCP + Noise + Yamux, QUIC), поведение **ElenaBehaviour** (Floodsub). Топики `elena-transactions` и `elena-alerts`. Фоновая задача: цикл `tokio::select!` между каналом команд (Listen, Dial, PublishTx, PublishAlert) и событиями Swarm (NewListenAddr, ConnectionEstablished, ConnectionClosed, FloodsubEvent::Message). Входящие сообщения десериализуются (bincode) в Transaction/Alert и отправляются в канал событий. **P2PNode**: `listen_on`, `dial`, `publish_transaction`, `publish_alert`, `inject_transaction` (для тестов), `event_sender`, `recv_event`, `run`. |
| **node/** | |
| `mod.rs` | **NodeConfig** (initial_balance, initial_reputation, chaff, data_dir). **ElenaNode**: KeyPair, peer_id (hash публичного ключа), баланс, репутация (DashMap), граф (RwLock<LocalGraph>), P2PNode, EchoLocator. `create_payment` (якорь, родители из графа, подпись, публикация в сеть). Обработка входящих: верификация подписи, добавление в граф или при коллизии создание Alert, публикация алерта, понижение репутации отправителя. `run()` — цикл по `recv_event`. `get_stats()` — JSON (peer_id, balance, reputation, число транзакций и алертов). |
| **main.rs** | CLI: **run** — balance, chaff, **--wallet** (загрузка ключей из data_dir/wallets/), **--admin** (RPC, по умолчанию 127.0.0.1:9190); **wallet** — создание и сохранение ключей; **send** / **stats** — через RPC к запущенному узлу. |
| **tests/integration.rs** | Тест двух узлов: создание платежа на первом, инъекция транзакции второму через `event_sender`, проверка появления транзакции в графе второго. |

### Криптография

- Подписи: **CRYSTALS-Dilithium3** (pqcrypto-dilithium), формат SignedMessage (sign/open).
- Хеши: **SHA3-512** (устойчивость к алгоритму Гровера в рамках модели).

### Сеть (libp2p 0.53)

- Транспорт: TCP и QUIC, аутентификация и шифрование **Noise**, мультиплексирование **Yamux**.
- Pub/Sub: **Floodsub**, топики для транзакций и алертов.
- Фичи: tcp, noise, yamux, floodsub, mdns, tokio, macros, quic.

### Тесты

- Юнит: crypto (подпись/верификация, хеш), graph (создание транзакции, коллизия по якорю), consensus (коллизия, уверенность).
- Интеграционный: два узла, платёж и приём по каналу событий (в т.ч. через inject).

### Документация

- **README.md**: быстрый старт, архитектура, криптография, сеть, пример запуска двух узлов, тесты, зависимости (в т.ч. macOS Xcode license).

---

## 3. Что есть в репозитории (итог)

- **elena-sim/** — симулятор на Python: полный цикл сценариев, репутация, квантовая атака, визуализация, A/B тесты, RESULTS.md.
- **elena-core/** — прототип на Rust: криптография (Dilithium3, SHA3-512), граф транзакций и алертов, эхо-локация, узел с балансом и репутацией, реальный P2P на libp2p, CLI, тесты.

Оба контура согласованы по идее протокола (якорь, коллизии, алерты, репутация) и готовы к дальнейшему развитию (новые сценарии в симуляторе, персистентность и доработка CLI в Rust).
