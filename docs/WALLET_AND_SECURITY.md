# Кошельки и безопасность — руководство для пользователей

Кратко: **один кошелёк в Елена = одна пара ключей на узле**. Веб-кошелёк подключается к узлу и показывает его баланс; отправка и стейкинг выполняются этим узлом. Ниже — как создать кошелёк, как им безопасно пользоваться и как защитить средства.

Подробная модель (для разработчиков и продвинутых пользователей): [WALLET_MODEL.md](WALLET_MODEL.md).

---

## Какой у вас случай?

### «Я зашёл на общий сайт кошелька»

- На этом сайте **один кошелёк на всех** — он принадлежит владельцу узла/сайта.
- Вы видите один и тот же баланс и адрес, что и другие посетители.
- **Чтобы только вы могли тратить средства**, владелец сайта должен включить защиту по API-ключу и выдать ключ только вам. В веб-кошельке вы один раз вводите этот ключ в **Настройки**; после этого отправка и стейкинг будут доступны только с вашего браузера (пока ключ сохранён).
- **Резервная копия:** её делает владелец узла (файл `.key` на сервере). Если вам нужен свой отдельный кошелёк с полным контролем — см. ниже «Свой кошелёк».

### «Я хочу свой кошелёк, чтобы только я им владел»

Тогда нужно **запустить свой узел** (или использовать свой контейнер Docker). Кошелёк создаётся при первом запуске узла или вручную через CLI.

#### Вариант A: CLI (рекомендуется для понимания)

1. **Создать кошелёк:**
   ```bash
   elena-core -d ~/.elena wallet myname
   ```
   Появится файл `~/.elena/wallets/mynam.key` и в консоль выведется адрес (публичный ключ в hex).

2. **Запустить узел с этим кошельком:**
   ```bash
   elena-core -d ~/.elena --listen /ip4/0.0.0.0/tcp/9000 run --wallet myname --admin 127.0.0.1:9190
   ```

3. **Запустить gateway** и открыть веб-кошелёк, указав в настройках URL своего gateway. Кошелёк в браузере = кошелёк вашего узла.

**Резервная копия:** скопируйте `~/.elena/wallets/mynam.key` в безопасное место (вне этого компьютера). Кто владеет файлом — владеет средствами. Права доступа: `chmod 600 ~/.elena/wallets/*.key`.

#### Вариант B: Docker

1. Запустите стек (например, `docker compose up -d`). При первом запуске контейнер узла сам создаёт кошелёк (например, `node1.key` в volume).

2. Узнать адрес: запрос к gateway `GET /api/v1/wallet/pubkey` или логи узла при создании.

3. **Резервная копия:** скопировать файл кошелька из контейнера:
   ```bash
   docker compose run --rm -v $(pwd)/backup:/backup node1 cp /data/wallets/node1.key /backup/
   ```
   Храните копию в безопасном месте.

---

## Защита доступа

### API-ключ на gateway (для общего сайта)

Если владелец gateway задал переменную **GATEWAY_API_KEY**, то:

- Читать баланс и адрес могут все.
- Отправлять и стейкать может только тот, кто передаёт правильный ключ (в веб-кошельке — один раз ввести в Настройки).

На сервере ключ задаётся, например:
```bash
export GATEWAY_API_KEY=ваш-секретный-ключ
```
В Docker — через `environment: GATEWAY_API_KEY` в `docker-compose.yml` и значение в `.env`. В веб-кошельке пользователь вводит этот же ключ в Настройках; он хранится только в браузере (sessionStorage), в код сборки не попадает.

### Admin-порт узла

Порт, на котором узел принимает команды (send, stake, stats), не должен быть доступен из интернета. Доступ только с хоста, где крутится gateway (или из доверенной сети). В Docker это обычно уже так (внутренняя сеть).

### HTTPS

Имеет смысл отдавать gateway и веб-кошелёк по HTTPS, чтобы трафик (в том числе API-ключ) не перехватывался.

---

## Краткая памятка

| Задача | Действие |
|--------|----------|
| Создать свой кошелёк | Запустить узел: `elena-core wallet <имя>` + `run --wallet <имя>`, или Docker (кошелёк создаётся сам). |
| Узнать свой адрес | Веб-кошелёк → «Получить», или запрос `GET /api/v1/wallet/pubkey`. |
| Защитить общий сайт от чужих трат | Задать `GATEWAY_API_KEY` на gateway; в браузере ввести ключ в Настройках. |
| Сохранить доступ к средствам | Сделать резервную копию файла `wallets/<имя>.key` и хранить в безопасном месте. |
