# Полный деплой сети «Елена»

## Краткий ответ

| Вопрос | Ответ |
|--------|-------|
| **Сколько узлов нужно?** | Минимум **1** (тест). Для работы в сети — **2+** узлов (чтобы синхронизироваться друг с другом). |
| **Что нужно пользователю для веб-кошелька?** | Только браузер и ссылка на сайт. Никаких установок. |
| **Зачем «общий» кошелёк?** | Потому что веб-кошелёк **не создаёт свой кошелёк** — он показывает кошелёк **узла**, к которому подключён gateway. |

---

## Архитектура: как всё связано

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  elena-web      │     │  elena-gateway  │     │  elena-core     │
│  (Vercel)       │ ──► │  (API, порт     │ ──► │  (узел, кошелёк │
│  Кошелёк в      │     │   9180)         │     │  хранится здесь)│
│  браузере       │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      Пользователь            Проксирует              Реальный
      видит баланс            команды узлу            владелец средств
```

**Важно:** Ключи и баланс хранятся **на узле**, а не в браузере. Web-кошелёк — это только интерфейс к одному узлу.

---

## Зачем нужен «общий» кошелёк — логика модели

### Текущая модель: 1 узел = 1 кошелёк

В «Елене» **каждый узел имеет свой кошелёк** (ключи хранятся в файле на узле). Подпись транзакций делается **на узле**.

Следствие:
- **Один gateway → один узел → один кошелёк**
- Все, кто заходит на веб-сайт кошелька и подключается к этому gateway, видят **один и тот же** кошелёк (кошелёк владельца узла)

### Это «общий кошелёк» — зачем он нужен?

| Сценарий | Кто владеет кошельком | Для кого |
|----------|------------------------|----------|
| **Общий сайт** | Владелец узла (вы) | Демо, внутренний сервис, тесты. Удобно: пользователь только открывает ссылку. |
| **Свой узел** | Пользователь | Тот, кому нужен свой кошелёк: устанавливает и запускает свой узел. |

**Общий кошелёк полезен когда:**
1. Нужно быстро показать, как работает сеть (демо)
2. У вас внутренний сервис и один «рабочий» кошелёк
3. Пользователи только принимают платежи (видят адрес), а траты контролируете вы

**Ограничения:**
- Все видят один баланс и один адрес
- Тратить могут только те, у кого есть доступ к узлу (или API-ключ gateway)
- Для личного кошелька каждому нужен свой узел (или будущая модель «кошелёк в браузере»)

### Будущее: кошелёк в браузере

Планируется модель, где у каждого пользователя будет свой кошелёк в браузере (ключи у пользователя, узел только рассылает готовые подписи). Пока её нет — работает модель «кошелёк узла».

---

## Сколько узлов нужно

| Режим | Узлов | Зачем |
|-------|-------|-------|
| **Минимальный (тест)** | 1 | Проверить, что всё работает. Сеть «сама с собой». |
| **Рабочий** | 2+ | Узлы синхронизируются по P2P, транзакции распространяются. |
| **Продакшен** | 3+ | Лучшая отказоустойчивость и покрытие сети. |

**Для старта достаточно 1–2 узлов.** Добавлять новые можно в любой момент.

---

## Что нужно пользователю, чтобы пользоваться веб-кошельком

### Ничего устанавливать не нужно

Пользователю нужны только:
1. Браузер
2. Ссылка на сайт кошелька (например, `https://elena-web-xxx.vercel.app`)

Он открывает ссылку и видит баланс и адрес узла, к которому подключён gateway.

**Если включена защита API-ключом (GATEWAY_API_KEY):**
- Просмотр баланса и адреса — без ключа
- Отправка и стейкинг — только с API-ключом (вводится в Настройках кошелька)

---

## Полный деплой: пошагово

### Вариант 1: Docker (локально или VPS)

Подходит для локального запуска или VPS (DigitalOcean, Hetzner, и т.п.).

```bash
cd "/Users/macbook/Протокол Елена"
docker compose up -d
```

После запуска:
- **Web-кошелёк:** http://localhost:3000
- **Owner dashboard:** http://localhost:3001
- **Gateway API:** http://localhost:9180
- **Узлы:** node1 (порты 19000, 19190), node2 (19001, 19191)

Gateway подключён к node1. Web и dashboard обращаются к gateway.

### Вариант 2: Публичный деплой (веб-кошелёк на Vercel)

Чтобы пользователи заходили по ссылке из интернета:

#### Шаг 1: Развернуть узел и gateway (VPS/облако)

На сервере (Railway, Fly.io, VPS с Docker):

1. **Узел elena-core**
   - Запустить с `--admin` для RPC
   - Открыть порт admin (9190) только для localhost или внутренней сети

2. **Gateway elena-gateway**
   - Подключить к узлу: `ELENA_NODE_ADMIN=127.0.0.1:9190`
   - Слушать на 9180
   - Должен быть доступен по HTTPS (nginx/Caddy перед ним или встроенный TLS)
   - Домен, например: `api.elena.example.com`

3. **(Опционально)** Включить `GATEWAY_API_KEY` для защиты отправки и стейкинга.

#### Шаг 2: Веб-кошелёк на Vercel

1. Deploy elena-web на Vercel (Git или `npx vercel --prod`)
2. В настройках проекта добавить переменную:
   - `VITE_API_URL` = `https://api.elena.example.com` (URL вашего gateway)
3. Сделать Redeploy

#### Шаг 3: Owner dashboard (по желанию)

- Локально: `VITE_API_URL=http://localhost:9180` и `npm run dev`
- Или отдельный хостинг с `VITE_API_URL` = URL вашего gateway

---

## Схема деплоя для работы в интернете

```
                    Пользователь
                         │
                         ▼
              ┌──────────────────────┐
              │  elena-web           │
              │  (Vercel)            │  ← Только фронт, бесплатно
              │  elena-web-xxx.vercel.app
              └──────────┬───────────┘
                         │ fetch(VITE_API_URL)
                         ▼
              ┌──────────────────────┐
              │  elena-gateway       │
              │  (VPS/Railway/Fly)   │  ← Должен быть публично по HTTPS
              │  api.elena.example.com
              └──────────┬───────────┘
                         │ TCP node1:9190
                         ▼
              ┌──────────────────────┐
              │  elena-core (node1)  │
              │  Кошелёк, граф,      │
              │  P2P к другим узлам  │
              └──────────────────────┘
                         │
                         ▼ P2P
              ┌──────────────────────┐
              │  elena-core (node2)  │  ← Второй узел (на другом сервере или том же)
              │  + node3, node4...   │
              └──────────────────────┘
```

---

## Контрольный список перед запуском

- [ ] Узел(el) запущены с `--admin`
- [ ] Gateway подключён к узлу и доступен по HTTPS
- [ ] CORS в gateway настроен (по умолчанию `allow_origin(Any)`)
- [ ] `VITE_API_URL` в Vercel указывает на URL gateway
- [ ] (Рекомендуется) `GATEWAY_API_KEY` задан для защиты отправки

---

## Резюме

1. **Узлов:** минимум 1, для нормальной работы — 2+.
2. **Пользователю веб-кошелька** нужен только браузер и ссылка.
3. **«Общий кошелёк»** — это кошелёк узла: один gateway → один узел → один кошелёк для всех посетителей сайта. Удобен для демо и внутренних сервисов; для личного кошелька нужен свой узел или будущая модель «кошелёк в браузере».
